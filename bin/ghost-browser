#!/bin/bash
# Wrapper for Ghost Chrome Runner API

API_URL="http://localhost:3000"
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

function show_help() {
  echo "Usage: ghost-browser <command> [args...]"
  echo ""
  echo "Lifecycle:"
  echo "  start               Start the Ghost Chrome Docker service"
  echo "  stop                Stop the service"
  echo "  restart             Restart the service"
  echo "  status              Check service health"
  echo "  view                Open live browser view"
  echo "  logs                Show Chrome internal logs"
  echo ""
  echo "Browser:"
  echo "  open <url>          Navigate to a URL"
  echo "  click <selector>    Click an element (human-like)"
  echo "  type <sel> <text>   Type text into an element (human-like)"
  echo "  snapshot            Get page text content"
  echo "  screenshot [file]   Save screenshot (default: screenshot.png)"
  echo ""
}

function ensure_curl() {
  if ! command -v curl &> /dev/null; then
    echo "âŒ Error: curl is required."
    exit 1
  fi
}

function check_status() {
  local response
  response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health")
  if [ "$response" == "200" ]; then
    return 0
  else
    return 1
  fi
}

function wait_for_service() {
  echo "â³ Waiting for Ghost Chrome to initialize..."
  for i in {1..60}; do
    if check_status; then
      echo "âœ… Ghost Chrome is ready!"
      return 0
    fi
    sleep 1
  done
  echo "âŒ Service timed out. Check 'docker logs ghost-browser'."
  exit 1
}

case "$1" in
  start)
    if check_status; then
      echo "âœ… Service is already running."
    else
      echo "ðŸ‘» Starting Ghost Chrome container..."
      cd "$DIR" && docker-compose up -d
      wait_for_service
    fi
    ;;

  stop)
    echo "ðŸ›‘ Stopping Ghost Chrome..."
    cd "$DIR" && docker-compose down
    ;;

  restart)
    echo "ðŸ”„ Restarting..."
    cd "$DIR" && docker-compose down && docker-compose up -d
    wait_for_service
    ;;

  view)
    echo "ðŸ‘€ Opening live view..."
    # Try open (mac), xdg-open (linux), or start (windows)
    open "$API_URL/view" 2>/dev/null || xdg-open "$API_URL/view" 2>/dev/null || start "$API_URL/view" 2>/dev/null || echo "Open browser to: $API_URL/view"
    ;;

  logs)
    ensure_curl
    curl -s "$API_URL/logs"
    echo ""
    ;;

  status)
    if check_status; then
      echo "âœ… Online"
    else
      echo "ðŸ”´ Offline"
      exit 1
    fi
    ;;

  open)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser open <url>"; exit 1; fi
    SAFE_URL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/navigate" \
      -H "Content-Type: application/json" \
      -d "{\"url\": \"$SAFE_URL\"}"
    echo ""
    ;;

  click)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser click <selector>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/click" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\"}"
    echo ""
    ;;

  type)
    ensure_curl
    if [ -z "$3" ]; then echo "Usage: ghost-browser type <selector> <text>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    SAFE_TEXT=$(echo "$3" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/type" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\", \"text\": \"$SAFE_TEXT\"}"
    echo ""
    ;;

  snapshot)
    ensure_curl
    curl -s "$API_URL/snapshot"
    echo ""
    ;;

  screenshot)
    ensure_curl
    OUT_FILE="${2:-screenshot.png}"
    curl -s "$API_URL/screenshot" -o "$OUT_FILE"
    echo "ðŸ“¸ Saved to $OUT_FILE"
    ;;

  help|--help|-h)
    show_help
    ;;

  *)
    echo "Unknown command: $1"
    show_help
    exit 1
    ;;
esac
