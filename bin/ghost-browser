#!/bin/bash
# Wrapper for Ghost Chrome Runner API

API_URL="http://localhost:3000"

# Find the project directory
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
DIR="$( cd -P "$( dirname "$SOURCE" )/.." && pwd )"

# Check if docker-compose.yml exists in the project root
if [ ! -f "$DIR/docker-compose.yml" ]; then
  echo "‚ùå Error: Could not find docker-compose.yml in $DIR"
  echo "Make sure the 'ghost-browser' script is located in the 'bin/' folder of the project repository."
  exit 1
fi

# Detect docker compose or docker-compose
if docker compose version &> /dev/null; then
  DC_CMD="docker compose"
elif docker-compose version &> /dev/null; then
  DC_CMD="docker-compose"
else
  echo "‚ùå Error: docker compose not found."
  exit 1
fi

function show_help() {
  echo "Usage: ghost-browser <command> [args...]"
  echo ""
  echo "Lifecycle:"
  echo "  start               Start the Ghost Chrome Docker service"
  echo "  stop                Stop the service"
  echo "  restart             Restart the service"
  echo "  status              Check service health"
  echo "  view                Open live browser view"
  echo "  logs                Show Chrome internal logs"
  echo ""
  echo "Browser:"
  echo "  open <url>          Navigate to a URL"
  echo "  click <selector>    Click an element (human-like)"
  echo "  dblclick <selector> Double-click an element"
  echo "  drag <src> <dest>   Drag and drop (human-like)"
  echo "  type <sel> <text>   Type text into an element (human-like)"
  echo "  fill <sel> <text>   Clear and type text (human-like)"
  echo "  hover <selector>    Hover an element (human-like)"
  echo "  scroll <y>          Scroll by y pixels"
  echo "  press <key>         Press a key (Enter, Escape, etc.)"
  echo "  wait <selector>     Wait for element to appear"
  echo "  tabs                List open tabs"
  echo "  switch <index>      Switch focus to tab"
  echo "  frame <sel>         Switch to iframe ('main' to exit)"
  echo "  upload <sel> <path> Upload file"
  echo "  highlight <sel>     Highlight element (visual feedback)"
  echo "  cookies             List cookies"
  echo "  cookies set <n> <v> Set cookie"
  echo "  snapshot            Get page text content"
  echo "  screenshot [file]   Save screenshot (default: screenshot.png)"
  echo ""
}

function ensure_curl() {
  if ! command -v curl &> /dev/null; then
    echo "‚ùå Error: curl is required."
    exit 1
  fi
}

function check_status() {
  local response
  response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health")
  if [ "$response" == "200" ]; then
    return 0
  else
    return 1
  fi
}

function wait_for_service() {
  echo "‚è≥ Waiting for Ghost Chrome to initialize..."
  for i in {1..60}; do
    if check_status; then
      echo "‚úÖ Ghost Chrome is ready!"
      return 0
    fi
    sleep 1
  done
  echo "‚ùå Service timed out. Check 'docker logs ghost-browser'."
  exit 1
}

case "$1" in
  start)
    if check_status; then
      echo "‚úÖ Service is already running."
    else
      echo "üëª Starting Ghost Chrome container..."
      cd "$DIR" && $DC_CMD up -d
      wait_for_service
    fi
    ;;

  stop)
    echo "üõë Stopping Ghost Chrome..."
    cd "$DIR" && $DC_CMD down
    ;;

  restart)
    echo "üîÑ Restarting..."
    cd "$DIR" && $DC_CMD down && $DC_CMD up -d
    wait_for_service
    ;;

  view)
    echo "üëÄ Opening live view..."
    # Try open (mac), xdg-open (linux), or start (windows)
    open "$API_URL/view" 2>/dev/null || xdg-open "$API_URL/view" 2>/dev/null || start "$API_URL/view" 2>/dev/null || echo "Open browser to: $API_URL/view"
    ;;

  logs)
    ensure_curl
    curl -s "$API_URL/logs"
    echo ""
    ;;

  status)
    if check_status; then
      echo "‚úÖ Online"
    else
      echo "üî¥ Offline"
      exit 1
    fi
    ;;

  open)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser open <url>"; exit 1; fi
    SAFE_URL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/navigate" \
      -H "Content-Type: application/json" \
      -d "{\"url\": \"$SAFE_URL\"}"
    echo ""
    ;;

  click)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser click <selector>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/click" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\", \"double\": false}"
    echo ""
    ;;

  dblclick)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser dblclick <selector>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/click" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\", \"double\": true}"
    echo ""
    ;;

  drag)
    ensure_curl
    if [ -z "$3" ]; then echo "Usage: ghost-browser drag <src> <dest>"; exit 1; fi
    SAFE_SRC=$(echo "$2" | sed 's/"/\\"/g')
    SAFE_DEST=$(echo "$3" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/drag" \
      -H "Content-Type: application/json" \
      -d "{\"source\": \"$SAFE_SRC\", \"target\": \"$SAFE_DEST\"}"
    echo ""
    ;;

  upload)
    ensure_curl
    if [ -z "$3" ]; then echo "Usage: ghost-browser upload <sel> <path>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    SAFE_PATH=$(echo "$3" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/upload" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\", \"filePath\": \"$SAFE_PATH\"}"
    echo ""
    ;;

  frame)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser frame <selector>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/frame" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\"}"
    echo ""
    ;;

  highlight)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser highlight <selector>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/highlight" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\"}"
    echo ""
    ;;

  type)
    ensure_curl
    if [ -z "$3" ]; then echo "Usage: ghost-browser type <selector> <text>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    SAFE_TEXT=$(echo "$3" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/type" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\", \"text\": \"$SAFE_TEXT\"}"
    echo ""
    ;;

  fill)
    ensure_curl
    if [ -z "$3" ]; then echo "Usage: ghost-browser fill <selector> <text>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    SAFE_TEXT=$(echo "$3" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/fill" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\", \"text\": \"$SAFE_TEXT\"}"
    echo ""
    ;;

  hover)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser hover <selector>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    curl -s -X POST "$API_URL/hover" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\"}"
    echo ""
    ;;

  scroll)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser scroll <y>"; exit 1; fi
    curl -s -X POST "$API_URL/scroll" \
      -H "Content-Type: application/json" \
      -d "{\"y\": $2}"
    echo ""
    ;;

  press)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser press <key>"; exit 1; fi
    curl -s -X POST "$API_URL/press" \
      -H "Content-Type: application/json" \
      -d "{\"key\": \"$2\"}"
    echo ""
    ;;

  wait)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser wait <selector>"; exit 1; fi
    SAFE_SEL=$(echo "$2" | sed 's/"/\\"/g')
    TIMEOUT="${3:-30000}"
    curl -s -X POST "$API_URL/wait" \
      -H "Content-Type: application/json" \
      -d "{\"selector\": \"$SAFE_SEL\", \"timeout\": $TIMEOUT}"
    echo ""
    ;;

  tabs)
    ensure_curl
    curl -s "$API_URL/tabs"
    echo ""
    ;;

  switch)
    ensure_curl
    if [ -z "$2" ]; then echo "Usage: ghost-browser switch <index>"; exit 1; fi
    curl -s -X POST "$API_URL/switch" \
      -H "Content-Type: application/json" \
      -d "{\"index\": $2}"
    echo ""
    ;;

  cookies)
    ensure_curl
    if [ "$2" == "set" ]; then
        if [ -z "$4" ]; then echo "Usage: ghost-browser cookies set <name> <value>"; exit 1; fi
        curl -s -X POST "$API_URL/cookies" \
          -H "Content-Type: application/json" \
          -d "{\"name\": \"$3\", \"value\": \"$4\"}"
    else
        curl -s "$API_URL/cookies"
    fi
    echo ""
    ;;

  snapshot)
    ensure_curl
    if [ "$2" == "-i" ] || [ "$2" == "--interactive" ]; then
      curl -s "$API_URL/snapshot/interactive"
    else
      curl -s "$API_URL/snapshot"
    fi
    echo ""
    ;;

  screenshot)
    ensure_curl
    OUT_FILE="${2:-screenshot.png}"
    curl -s "$API_URL/screenshot" -o "$OUT_FILE"
    echo "üì∏ Saved to $OUT_FILE"
    ;;

  help|--help|-h)
    show_help
    ;;

  *)
    echo "Unknown command: $1"
    show_help
    exit 1
    ;;
esac
